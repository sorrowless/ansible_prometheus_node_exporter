#!/usr/bin/env bash

set -e

IFS=';' read -r UPDATES SECURITY <<< $(/usr/lib/update-notifier/apt-check 2>&1)
REBOOT=$([ -f /var/run/reboot-required ] && echo 1 || echo 0)
TMP_APT=/tmp/apt$$.prom

echo "# HELP apt_upgrades_pending Apt package pending updates by origin." > ${TMP_APT}
echo "# TYPE apt_upgrades_pending gauge" >> ${TMP_APT}
echo "apt_upgrades_pending ${UPDATES}" >> ${TMP_APT}

echo "# HELP apt_security_upgrades_pending Apt package pending security updates by origin." >> ${TMP_APT}
echo "# TYPE apt_security_upgrades_pending gauge" >> ${TMP_APT}
echo "apt_security_upgrades_pending ${SECURITY}" >> ${TMP_APT}

echo "# HELP node_reboot_required Node reboot is required for software updates." >> ${TMP_APT}
echo "# TYPE node_reboot_required gauge" >> ${TMP_APT}
echo "node_reboot_required ${REBOOT}" >> ${TMP_APT}

mv ${TMP_APT} {{ node_textfile_collector_dir }}/apt.prom
